<!doctype html>
<html>
<head>
<meta charset="utf8"/>
<style>

#taskboard {
    border: 1px solid black;
}

.taskboardPane {
    display: inline-block;
    border: 1px solid red;
    margin: 10px;
    padding: 10px;
    width: 200px;
    height: 200px;
}

.task {
    background-color: yellow;
    border: 1px solid #808000;
}

</style>
</head>
<body>

<fieldset id="gameInfo">
    <legend>Game Info</legend>
    <div id="roundNumber"></div>
    <div id="score"></div>
    <div id="timeWastedByBAs"></div>
    <div id="timeWastedByDevelopers"></div>
</fieldset>

<fieldset id="taskboard">
    <legend>Taskboard</legend>

    <fieldset class="taskboardPane">
        <legend>Backlog</legend>
        <div id="backlog"></div>
    </fieldset>

    <fieldset class="taskboardPane">
        <legend>In Progress</legend>
        <div id="inProgress"></div>
    </fieldset>

    <fieldset class="taskboardPane">
        <legend>Complete</legend>
        <div id="complete"></div>
    </fieldset>
</fieldset>

<fieldset>
    <legend>Requests for Outlookowiec</legend>
    <div id="requests"></div>
</fieldset>

<fieldset>
    <legend>Actions</legend>
    <a href="#" onclick="step(); return false;">Do nothing</a>
    <p>To handle a request, just click on in.</p>
</fieldset>

<script>
    var backlog = [];
    var inProgress = [];
    var complete = [];

    var round = 1;
    var score = 0;
    var taskCounter = 0;
    var requestCounter = 0;

    var requestsFromAnalysts = [];
    var requestsFromDevelopers = [];
    var requestsFromSupport = [];

    var timeWastedByBAs = 0;
    var timeWastedByDevelopers = 0;

    function solve(id) {
        for (var i = 0; i < requestsFromAnalysts.length; i++) {
            var request = requestsFromAnalysts[i];
            if (request.id == id) {
                requestsFromAnalysts.splice(i, 1);
            }
        }

        for (var i = 0; i < requestsFromDevelopers.length; i++) {
            var request = requestsFromDevelopers[i];
            if (request.id == id) {
                requestsFromDevelopers.splice(i, 1);
                var taskId = request.refId;
                for (var j = 0; j < inProgress.length; j++) {
                    var task = inProgress[j];
                    if (task.id == taskId) {
                        task.status="InProgress";
                    }
                }
            }
        }

        for (var i = 0; i < requestsFromSupport.length; i++) {
            var request = requestsFromSupport[i];
            if (request.id == id) {
                requestsFromSupport.splice(i, 1);
            }
        }
        step();
    }

    function printTasks(taskboardPhase) {
        if (taskboardPhase.length == 0) {
            return "<p>None!</p>"
        }
        var result = "";
        for (var i = 0; i < taskboardPhase.length; i++) {
            result += "<p class='task' onclick='solve("+taskboardPhase[i].id+");'>" + taskboardPhase[i].getName() +"</p>";
        }
        return result;
    }

    function step() {
        // If developers are not doing anything and backlog has something
        // they will pick it

        var developersHadSomethingToDo = false;
        var analystsHadSomethingToDo = false;

        if (inProgress.length == 0 && backlog.length > 0) {
            var task = backlog.pop();
            inProgress.push(task);
            var newRequest = {
                id:(requestCounter++),
                type:"DevAnalysis",
                refId:task.id,
                getName:function() {return "Dev Analysis for task #"+task.id}
            }
            requestsFromDevelopers.push(newRequest);
            developersHadSomethingToDo = true;
        }

        // If developers have a card and all othe requests from developers are handled
        // they may have a question
        if (inProgress.length > 0 && requestsFromDevelopers.length == 0) {
            var task = inProgress[0];
            if (Math.random() > 0.8) {
                var newQuestion = {
                    id:(requestCounter++),
                    status:"new",
                    refId:undefined,
                    getName:function() {return "Question #"+this.id+" from developers for task #"+task.id}
                    }
                requestsFromDevelopers.push(newQuestion);
                developersHadSomethingToDo = true;
            } else if (Math.random() > 0.8) {
                for (var i = 0; i < inProgress.length; i++) {
                    if (task.id == inProgress[i].id) {
                        inProgress.splice(i, 1);
                    }
                }
                complete.push(task);
                score += task.importance;
                developersHadSomethingToDo = true;
            }

            // Developers just doing their job
            developersHadSomethingToDo = true;
        }

        // If there are no more than 4 cards in Backlog and all
        // requests from analysts are handled
        // analysts may create new task
        if (requestsFromAnalysts.length == 0 && backlog.length < 5) {
            if (Math.random() > 0.8) {
                var newTask = {
                    id:(taskCounter++),
                    status:"new",
                    importance: Math.floor((Math.random() * 10) + 1),
                    getName:function() {return "Task #"+this.id}
                    }
                backlog.push(newTask);
                analystsHadSomethingToDo = true;
            }

            // They may also have a question for Outlookowiec
            if (Math.random() > 0.8) {
                var newQuestion = {
                    id:(requestCounter++),
                    status:"new",
                    getName:function() {return "Question #"+this.id+" from BAs"}
                    }
                requestsFromAnalysts.push(newQuestion);
                analystsHadSomethingToDo = true;
            }

            // Analysts just doing their job
            analystsHadSomethingToDo = true;
        }

        // Support requests may appear
        if (Math.random()>0.8) {
            var newSupportRequest = {
                id:(requestCounter++),
                status:"new",
                getName:function() {return "Support request #"+this.id+" from clients"}
                }
            requestsFromSupport.push(newSupportRequest);
        }

        if (!developersHadSomethingToDo) {
            timeWastedByDevelopers += 1;
        }

        if (!analystsHadSomethingToDo) {
            timeWastedByBAs += 1;
        }

        var analystsWastedTimePercent = Math.floor(100 * timeWastedByBAs / round);
        var developersWastedTimePercent = Math.floor(100 * timeWastedByDevelopers / round);

        document.getElementById("roundNumber").innerHTML = "<p>Round: "+round+"</p>";
        document.getElementById("score").innerHTML = "<p>Score: "+score+"</p>";
        document.getElementById("timeWastedByBAs").innerHTML = "<p>Time wasted by BAs: "+timeWastedByBAs+" ("+analystsWastedTimePercent+"%)</p>";
        document.getElementById("timeWastedByDevelopers").innerHTML = "<p>Time wasted by developers: "+timeWastedByDevelopers+" ("+developersWastedTimePercent+"%)</p>";

        document.getElementById("backlog").innerHTML =  printTasks(backlog);
        document.getElementById("inProgress").innerHTML =  printTasks(inProgress);
        document.getElementById("complete").innerHTML =  printTasks(complete);

        var allRequests = requestsFromAnalysts.concat(requestsFromDevelopers).concat(requestsFromSupport);

        document.getElementById("requests").innerHTML = printTasks(allRequests);

        round +=1 ;

        return false;
    }

    step();

</script>

</body>
</html>
